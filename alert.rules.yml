groups:
  - name: http_alerts
    rules:
      - alert: Non2xxErrorDetected
        expr: increase(http_server_requests_seconds_count{status!~"2.."}[1m]) > 0
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "[HTTP Alert] ìƒíƒœ ì½”ë“œ {{ $labels.status }} ì˜¤ë¥˜ ê°ì§€"
          description: >
            â— ìµœê·¼ 1ë¶„ ë™ì•ˆ ë‹¤ìŒ ì˜¤ë¥˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.
            â€¢ ìƒíƒœ ì½”ë“œ: {{ $labels.status }}
            â€¢ URI: {{ $labels.uri }}
            â€¢ ë©”ì„œë“œ: {{ $labels.method }}
            â€¢ ì´ ë°œìƒ íšŸìˆ˜: {{ $value | printf "%.0f" }} íšŒ

      # 95í¼ì„¼íƒ€ì¼ ê¸°ì¤€ ì‘ë‹µ ì§€ì—° ê°ì§€ (1ì´ˆ ì´ìƒ)
      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[1m])) by (le)) > 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "[Performance Alert] P95 ì‘ë‹µ ì§€ì—° ì´ˆê³¼"
          description: >
            â± ìµœê·¼ 1ë¶„ê°„ ì „ì²´ ìš”ì²­ì˜ 95% ì‘ë‹µ ì‹œê°„ì´ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.
            ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.

      # 99í¼ì„¼íƒ€ì¼ ê¸°ì¤€ ì‘ë‹µ ì§€ì—° ì‹¬ê° (2ì´ˆ ì´ìƒ)
      - alert: HighLatencyP99
        expr: histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[1m])) by (le)) > 2
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "[Performance Alert] P99 ì‘ë‹µ ì§€ì—° ì‹¬ê°"
          description: >
            â± ìµœê·¼ 1ë¶„ê°„ ì „ì²´ ìš”ì²­ì˜ 99% ì‘ë‹µ ì‹œê°„ì´ 2ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.
            ê¸´ê¸‰í•œ ì„±ëŠ¥ ë³‘ëª©ì´ ë°œìƒí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

      # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ê²½ê³ 
      - alert: HighJvmMemoryUsage
        expr: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.9
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "JVM ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 90% ì´ˆê³¼"
          description: >
            ğŸš¨ í˜„ì¬ JVM ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 90%ë¥¼ ì´ˆê³¼í•˜ê³  ìˆìŠµë‹ˆë‹¤.

      # GC ì‹œê°„ ì§€ì—° ê°ì§€
      - alert: LongGcPause
        expr: rate(jvm_gc_pause_seconds_sum[1m]) > 0.5
        for: 30s
        labels:
          severity: warning
        annotations:
          summary: "JVM GC ì§€ì—° ë°œìƒ"
          description: >
            âš ï¸ ìµœê·¼ GCë¡œ ì¸í•œ ì§€ì—°ì´ 0.5ì´ˆ ì´ìƒ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

      # ìš”ì²­ ìˆ˜ ê¸‰ì¦ ê°ì§€ (íŠ¸ë˜í”½ ì´ìƒ íƒì§€)
      # ì‹¤ ìš´ì˜) 1ë¶„ê°„ 180ê±´ ì´ìƒ ìš”ì²­(> 3) ë°œìƒ ì‹œ ê°ì§€ | 1ë¶„ê°„ ê³„ì† ìœ ì§€ë˜ì—ˆì„ ë•Œë§Œ Alert ë°œë™
      - alert: SuddenTrafficSpike
        expr: rate(http_server_requests_seconds_count[1m]) > 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "[Traffic Alert] íŠ¸ë˜í”½ ê¸‰ì¦ ê°ì§€"
          description: >
            ğŸš¨ ìµœê·¼ 1ë¶„ê°„ ì´ˆë‹¹ ìš”ì²­ ìˆ˜ê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.
            â€¢ ì´ˆë‹¹ í‰ê·  ìš”ì²­ ìˆ˜: {{ $value | printf "%.2f" }}

      # OpenAI API ì‚¬ìš©ëŸ‰ 80% ì´ˆê³¼ (1ë¶„ ê¸°ì¤€)
      - alert: GptUsage80PercentThreshold
        expr: increase(external_api_token_usage_total{api="openai"}[1m]) > 160
        for: 30s
        labels:
          severity: warning
        annotations:
          summary: "[GPT Alert] OpenAI API ì‚¬ìš©ëŸ‰ 80% ì´ˆê³¼"
          description: >
            ğŸš¨ ìµœê·¼ 1ë¶„ê°„ OpenAI API ì‚¬ìš©ëŸ‰ì´ ì„ê³„ì¹˜(80%)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.
            â€¢ ì‚¬ìš©ëŸ‰: {{ $value | printf "%.0f" }} / 200

      # YouTube API ì‚¬ìš©ëŸ‰ 80% ì´ˆê³¼ (1ë¶„ ê¸°ì¤€)
      - alert: YoutubeUsage80PercentThreshold
        expr: increase(external_api_token_usage_total{api="youtube"}[1m]) > 8000
        for: 30s
        labels:
          severity: warning
        annotations:
          summary: "[YouTube Alert] YouTube API ì‚¬ìš©ëŸ‰ 80% ì´ˆê³¼"
          description: >
            ğŸš¨ ìµœê·¼ 1ë¶„ê°„ YouTube API ì‚¬ìš©ëŸ‰ì´ ì„ê³„ì¹˜(80%)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.
            â€¢ ì‚¬ìš©ëŸ‰: {{ $value | printf "%.0f" }} / 10000
            

# ---   test   ------------------------------------------------------------------------------------------
  - name: test_http_alerts
    rules:
      - alert: Test_Non2xxErrorDetected
        expr: increase(http_server_requests_seconds_count{status!~"2.."}[1m]) > 0
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "[TEST] ìƒíƒœ ì½”ë“œ ì˜¤ë¥˜ ê°ì§€"
          description: |
            ğŸ”§ í…ŒìŠ¤íŠ¸ ì•ŒëŒ: 1ë¶„ ë‚´ 2xx ì™¸ ìƒíƒœ ì½”ë“œ ë°œìƒ.

      - alert: Test_GptApiUsage
        expr: increase(external_api_token_usage_total{api="openai"}[1m]) > 1
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "[TEST] GPT API ì‚¬ìš©ëŸ‰ ê²½ê³ "
          description: |
            ğŸ”§ í…ŒìŠ¤íŠ¸ ì•ŒëŒ: GPT API 1ê±´ ì´ìƒ ì‚¬ìš©.

      - alert: Test_YoutubeApiUsage
        expr: increase(external_api_token_usage_total{api="youtube"}[1m]) > 1
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "[TEST] YouTube API ì‚¬ìš©ëŸ‰ ê²½ê³ "
          description: |
            ğŸ”§ í…ŒìŠ¤íŠ¸ ì•ŒëŒ: YouTube API 1ê±´ ì´ìƒ ì‚¬ìš©.

